name: CI - Full Stack Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  smart-contracts:
    name: Test Smart Contracts
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./expansion-packs/bmad-blockchain-dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: expansion-packs/bmad-blockchain-dev/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npx hardhat compile

      - name: Run tests
        run: npm test
        env:
          REPORT_GAS: true

      - name: Check contract sizes
        run: npx hardhat size-contracts

      - name: Generate coverage report
        run: npm run coverage || true
        continue-on-error: true

  frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    if: false  # Disabled until frontend directory is properly set up
    defaults:
      run:
        working-directory: ./kektech-mainnet-frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: kektech-mainnet-frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || true
        continue-on-error: true

      - name: Run tests
        run: npm test || true
        continue-on-error: true

      - name: Build
        run: npm run build

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [smart-contracts]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run integration tests
        run: |
          echo "Integration tests would run here"
          echo "Testing contract-frontend interaction"
          echo "Status: Placeholder for now"