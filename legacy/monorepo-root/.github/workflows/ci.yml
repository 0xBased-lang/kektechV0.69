name: CI - Full Stack Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  smart-contracts:
    name: Test Smart Contracts
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./packages/blockchain

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: packages/blockchain/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npx hardhat compile

      - name: Run tests
        run: npm test
        env:
          REPORT_GAS: true

      - name: Check contract sizes
        run: npx hardhat size-contracts

      - name: Generate coverage report
        run: npm run coverage || true
        continue-on-error: true

  frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_APP_URL: https://kektech-frontend.vercel.app
      NEXT_PUBLIC_VERCEL_URL: kektech-frontend.vercel.app
      NEXT_PUBLIC_REOWN_PROJECT_ID: dc5e6470d109f31f1d271b149fed3d98
      NEXT_PUBLIC_WS_URL: wss://ws.kektech.xyz/ws
      NEXT_PUBLIC_SUPABASE_URL: https://example.supabase.co
      NEXT_PUBLIC_SUPABASE_ANON_KEY: supabase-anon-key
      SUPABASE_SERVICE_KEY: supabase-service-key
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
      NEXT_PUBLIC_CHAIN_ID: '32323'
      NEXT_PUBLIC_RPC_URL: https://mainnet.basedaibridge.com/rpc/
      NEXT_PUBLIC_EXPLORER_URL: https://explorer.bf1337.org
      NEXT_PUBLIC_CONTRACT_ADDRESS: 0x40B6184b901334C0A88f528c1A0a1de7a77490f1
      NEXT_PUBLIC_VERSIONED_REGISTRY: 0x67F8F023f6cFAe44353d797D6e0B157F2579301A
      NEXT_PUBLIC_MARKET_FACTORY: 0x3eaF643482Fe35d13DB812946E14F5345eb60d62
      NEXT_PUBLIC_PARAMETER_STORAGE: 0x0FdcaCE9dEE78c70C92B243346cDf763A06fEdF8
      NEXT_PUBLIC_ACCESS_CONTROL_MANAGER: 0x4d1afBb8E50e17F24dCbB4Fc3197537be646315A
      NEXT_PUBLIC_RESOLUTION_MANAGER: 0x10daF33E321ED8977e369a36FcC6Beb3d3d106a0
      NEXT_PUBLIC_REWARD_DISTRIBUTOR: 0x3D274362423847B53E43a27b9E835d668754C96B
      NEXT_PUBLIC_CURVE_REGISTRY: 0x5AcC0f00c0675975a2c4A54aBcC7826Bd229Ca70
      NEXT_PUBLIC_PREDICTION_MARKET_TEMPLATE: 0x1064f1FCeE5aA859468559eB9dC9564F0ef20111
      NEXT_PUBLIC_MARKET_TEMPLATE_REGISTRY: 0x420687494Dad8da9d058e9399cD401Deca17f6bd
      NEXT_PUBLIC_METADATA_API: https://kektech.xyz/api/metadata
      NEXT_PUBLIC_RANKING_API: https://api.kektech.xyz
      UPSTASH_REDIS_REST_URL: https://example.upstash.io
      UPSTASH_REDIS_REST_TOKEN: test-token

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run frontend lint
        run: npm run lint

      - name: Run frontend tests
        run: npm run test:frontend

      - name: Build frontend
        run: npm run build

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [smart-contracts]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Run integration tests
        run: |
          echo "Integration tests would run here"
          echo "Testing contract-frontend interaction"
          echo "Status: Placeholder for now"
